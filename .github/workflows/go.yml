name: Deploy TG Bot

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  DEPLOY_HOST: 46.151.31.207
  DEPLOY_DIR: /root/go_vpn_bot
  TMUX_SESSION: go_vpn_bot
  BIN_NAME: telegram_vpn_bot_go

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go (from go.mod)
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install build deps (CGO for sqlite3)
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc sqlite3 libsqlite3-dev

      - name: Build linux/amd64 (CGO=1)
        env:
          CGO_ENABLED: 1
          GOOS: linux
          GOARCH: amd64
        run: |
          go version
          mkdir -p build
          go build -trimpath -buildvcs=false -ldflags="-s -w" \
            -o build/${BIN_NAME} .

      # –ü–æ–¥–∫–ª—é—á–∞–µ–º ssh-agent, —á—Ç–æ–±—ã –∫–ª—é—á –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
      - name: Use SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          # –µ—Å–ª–∏ –∫–ª—é—á —Å –ø–∞—Ä–æ–ª–µ–º, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π:
          # ssh-passphrase: ${{ secrets.SSH_PASSPHRASE }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${DEPLOY_HOST} >> ~/.ssh/known_hosts

      - name: Upload binary
        run: |
          ssh -o StrictHostKeyChecking=yes -o ConnectTimeout=10 root@${DEPLOY_HOST} "mkdir -p ${DEPLOY_DIR}"
          scp -o StrictHostKeyChecking=yes -o ConnectTimeout=10 build/${BIN_NAME} \
              root@${DEPLOY_HOST}:${DEPLOY_DIR}/${BIN_NAME}.new
          ssh -o StrictHostKeyChecking=yes -o ConnectTimeout=10 root@${DEPLOY_HOST} \
              "chmod +x ${DEPLOY_DIR}/${BIN_NAME}.new"

      - name: Deploy & Restart via tmux
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          ssh -o StrictHostKeyChecking=yes -o ConnectTimeout=10 root@${DEPLOY_HOST} bash -c "'
            set -e
            cd ${DEPLOY_DIR}

            # –ë—ç–∫–∞–ø –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
            if [ -f ${BIN_NAME} ]; then
              cp -f ${BIN_NAME} ${BIN_NAME}.bak || true
            fi

            # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
            tmux has-session -t ${TMUX_SESSION} 2>/dev/null && tmux kill-session -t ${TMUX_SESSION} || true

            # –û–±–Ω–æ–≤–∏—Ç—å –±–∏–Ω–∞—Ä—å
            mv -f ${BIN_NAME}.new ${BIN_NAME}
            chmod +x ${BIN_NAME}
            mkdir -p logs

            # –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
            tmux new-session -d -s ${TMUX_SESSION} \"TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN} ./\${BIN_NAME} >> logs/bot.log 2>&1\"

            sleep 2
            tmux has-session -t ${TMUX_SESSION} 2>/dev/null || { echo \"‚ùå tmux –Ω–µ —Å—Ç–∞—Ä—Ç–∞–Ω—É–ª\"; exit 1; }

            echo \"üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:\"
            tail -n 50 logs/bot.log || true
          '"
